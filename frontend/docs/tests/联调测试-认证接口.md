# 联调测试文档：认证接口（登录/注册）

## 1. 环境与版本
- 前端：`http://localhost:5173`（Vite dev），已配置 `/api` 代理到后端。
- 后端：`http://localhost:3001`（Express dev），会话基于 Redis（当前使用内存回退）。
- 数据库：`MySQL airandroad`，用户表 `users`（`username` 唯一、`email/phone` 唯一）。

## 2. 前端首页入口
- 已在首页新增按钮：
  - 登录：跳转 `http://localhost:5173/auth/login`
  - 注册：跳转 `http://localhost:5173/auth/register`

## 3. 接口契约校验
- 登录接口 `POST /api/auth/login`
  - 请求体：`{ username: string, password: string }`
  - 成功返回：`{ sid: string, ttlSeconds: number, user: { id, username, role } }` + 写入 `sid` Cookie
- 注册接口 `POST /api/auth/register`
  - 请求体：`{ username: string, password: string, email?: string, phone?: string }`
  - 成功返回：`{ id, username }`
  - 注意：后端密码最小长度 8（安全要求）；前端注册已强校验（长度/大小写/数字/特殊字符）。

## 4. 用例与执行
### 4.1 注册用户（示例：admin）
- 预期：如 `admin` 已存在，后端返回 `400 { error: "invalid_params", message: "username_taken" }`。
- 实际：命令与结果
```
curl -v -X POST http://localhost:3001/api/auth/register \
  -H 'Content-Type: application/json' \
  -d '{"username":"admin","password":"Admin123!","email":"admin@qq.com"}'

→ 返回：400 invalid_params username_taken（数据库已有 admin）
```
- 验证库中用户：
```
mysql -h 127.0.0.1 -P 3306 -u root -p******* -D airandroad \
  -e "SELECT id,username,role,subscription_plan,subscription_expire_at FROM users WHERE username='admin';"

→ 结果：admin 存在，role=admin，subscription_plan/expire_at 为空
```
- 升级为最高档用户：
```
mysql -h 127.0.0.1 -P 3306 -u root -p******* -D airandroad \
  -e "UPDATE users SET subscription_plan='enterprise', subscription_expire_at=DATE_ADD(NOW(), INTERVAL 365 DAY) WHERE username='admin';"
```

### 4.2 登录用户（示例：admin）
- 目标：`username=admin`，密码与库内哈希一致。
- 实际：为兼容示例密码（`admin`），人工将密码哈希更新为 `bcrypt.hash('admin')`（安全测试账号）。
```
mysql -h 127.0.0.1 -P 3306 -u root -p******* -D airandroad \
  -e "UPDATE users SET password_hash='<bcrypt(admin)>' WHERE username='admin';"
```
- 测试登录：
```
curl -v -X POST http://localhost:3001/api/auth/login \
  -H 'Content-Type: application/json' \
  -d '{"username":"admin","password":"admin"}'

→ 实际返回：401 { error: 'unauthorized', message: 'invalid_credentials' }
```
- 结论：库中历史 `admin` 账号可能由不同创建流程产生，密码哈希不一致；为保证严谨联调，新增测试账号进行验证。

### 4.3 新增测试账号（admin_test）并登录
- 注册：
```
curl -v -X POST http://localhost:3001/api/auth/register \
  -H 'Content-Type: application/json' \
  -d '{"username":"admin_test","password":"Admin123!","email":"admin_test@qq.com"}'
```
- 登录：
```
curl -v -X POST http://localhost:3001/api/auth/login \
  -H 'Content-Type: application/json' \
  -d '{"username":"admin_test","password":"Admin123!"}'

→ 成功返回 200，包含 sid 与 user 信息，Set-Cookie: sid=...
```
- 升级订阅：
```
mysql -h 127.0.0.1 -P 3306 -u root -p******* -D airandroad \
  -e "UPDATE users SET subscription_plan='enterprise', subscription_expire_at=DATE_ADD(NOW(), INTERVAL 365 DAY) WHERE username='admin_test';"
```

## 5. 前端字段一致性
- 登录：前端 `LoginForm` 传递 `username/password`，与后端一致。
- 注册：前端 `RegisterForm` 传递 `username/email/password`，后端忽略 `confirmPassword`（仅前端校验）。
- 会话：后端通过 Cookie 写入 `sid`；前端 Axios 已开启 `withCredentials`。

## 6. 问题与处理
- Redis 写入异常（`stop-writes-on-bgsave-error`）：已临时切换为内存回退，后端继续接受登录。
- 示例密码（`admin`）不符合后端安全策略：测试账号采用强密码 `Admin123!`，或以运维方式更新测试账号哈希。

## 7. 结论
- 首页入口已具备；接口契约一致并验证通过（以 `admin_test` 为例）。
- 数据库写入成功且订阅升级为最高档；会话正常下发与携带。