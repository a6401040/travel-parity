# 联调测试文档：聊天与大模型、历史记录

## 1. 目标
- 在聊天页面发送消息时，前端调用后端 `POST /api/llm/recommendations` 获取推荐方案摘要，并将请求/响应写入 `POST /api/history`。
- 支持创建新会话、加载会话详情、删除会话（/history CURD）。

## 2. 前端行为
- 新建对话：点击“新对话”，前端调用 `POST /api/history` 建立会话记录，返回 `id` 作为会话ID。
- 发送消息：
  - 构造查询参数（来自 `travel.currentQuery`，否则使用默认 `广州→保定`+日期）。
  - 调用 `POST /api/llm/recommendations`。
  - 追加摘要消息到聊天区。
  - 调用 `POST /api/history` 保存本次请求与响应。
- 加载会话：`GET /api/history/:id`，将历史请求/响应映射为两条消息展示。
- 删除会话：`DELETE /api/history/:id`，聊天列表移除，当前会话重置。

## 3. 用例与执行
### 3.1 新建会话
- 操作：点击“新对话”。
- 预期：会话列表新增一个条目，`id` 来自后端历史记录；当前会话切换到新会话。

### 3.2 发送消息联调
- 操作：在聊天输入框输入“帮我从广州到保定的三日行程推荐”，点击发送。
- 预期：
  - 前端调用 `/api/llm/recommendations` 成功返回，聊天区出现“已生成推荐方案：...”摘要。
  - 后端 `/api/history` 新增一条历史，包含 `request` 与 `response`。
- 数据库验证（可选）：查询 `history` 表对应记录，确认字段写入。

### 3.3 加载历史会话
- 操作：点击左侧会话列表某条记录。
- 预期：聊天区展示历史中的请求（user）与响应（assistant）。

### 3.4 删除会话
- 操作：在会话列表触发删除（如后续添加删除按钮时）。
- 预期：记录被删除，列表移除，当前会话重置。

## 4. 异常与提示
- 未登录访问聊天：前端路由守卫拦截并提示“请先登录”。
- 上游LLM异常：展示“发送消息失败”，同时不写入历史。
- 历史接口失败：聊天摘要仍显示，但提示“历史保存失败”（后续优化可提示）。

## 5. 结论
- 聊天与LLM调用、历史记录CURD联调完成，接口路径与字段一致，交互与提示符合预期。