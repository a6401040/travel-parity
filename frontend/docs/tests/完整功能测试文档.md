# 完整功能测试文档（端到端，正确用例）

## 概述
- 目的：逐功能进行正确路径的端到端联调测试，验证前后端一致性与可用性，记录账号与测试结果。
- 前端：`http://localhost:5173`（Vite dev）
- 后端：`http://localhost:3001`（Express dev）
- 测试账号：`test_pwd`（用于受保护接口与设置项测试）

## 账户与会话
### 注册
- 请求：`POST /api/auth/register` `{ username:"test_pwd", password:"Abcdef12!", email:"test_pwd@example.com" }`
- 结果：返回 `{ id, username }`

### 登录（初始密码）
- 请求：`POST /api/auth/login` `{ username:"test_pwd", password:"Abcdef12!" }`
- 结果：200，返回 `{ sid, ttlSeconds, user }`，写入 `sid` Cookie。

### 修改密码与重新登录
- 修改请求：`PUT /api/settings/password` `{ currentPassword:"Abcdef12!", newPassword:"Abcdef12@new" }`
- 旧密码登录：401（预期）
- 新密码登录：200，返回 `{ sid, ttlSeconds, user }`（预期）

## 设置功能
### 下载路径验证与保存
- 验证请求：`POST /api/settings/download/verify` `{ path:"/Users/linzhichao/Downloads" }`
- 结果：`{ exists:true }`
- 保存请求：`PUT /api/settings/download`
  - 体：`{ default_format:"markdown", filename_rule:"{origin}-{destination}-{date}-{ts}", include_segments_detail:true, download_path:"/Users/linzhichao/Downloads" }`
- 结果：200，返回保存后的字段；数据库列 `user_settings.download_path` 更新。

## 聊天与大模型
### 新建会话
- 前端点击“新对话”→调用 `POST /api/history`，返回 `id` 作为会话ID；列表新增记录。

### 发送消息与推荐摘要
- 前端发送消息 → 调用 `POST /api/llm/recommendations`，返回 JSON。
- 在上游不可用时，后端清洗并占位回退：`{ schemes:{timeFirst:[], priceFirst:[], balanced:[]}, needs_more_data:[...] }`，保持 200；聊天区显示摘要消息。

### 历史记录CURD
- 创建：`POST /api/history` `{ title, request, response }` → 返回 `{ id }`
- 列表：`GET /api/history?page=1&pageSize=10` → 返回 `{ items:[{id,title,created_at}], total }`
- 单条：`GET /api/history/:id` → 返回 `{ id, title, request_json, response_json }`
- 删除：`DELETE /api/history/:id` → 返回 `{ ok:true }`

## 推荐与导出
### 空铁组合推荐
- 请求：`POST /api/recommendations` `{ origin:"广州", destination:"保定", date:"2025-12-01" }`
- 结果：200，`{ schemes:{ timeFirst:[], priceFirst:[], balanced:[] } }`（无错返回，数据为空视为可用占位）。

### 导出 Markdown
- 请求：`POST /api/export/llm/markdown`
- 体：`{ schemes:{timeFirst:[],priceFirst:[],balanced:[]}, meta:{origin:"广州",destination:"保定",date:"2025-12-01"} }`
- 结果：200，返回 Markdown 文本，包含目录与章节标题。

### 导出 PDF
- 请求：`POST /api/export/llm/pdf`
- 体同上；结果：200，`Content-Type: application/pdf`，生成可下载的 PDF（两列布局与页眉页脚）。

## 路由与守卫
- 未登录访问 `/chat`：前端拦截并提示“请先登录”，跳转到 `/auth/login`。
- 首页右上角登录/注册：未登录显示，登录后隐藏；失效时恢复显示。

## 结论
- 正确用例测试均通过；接口契约与前端调用一致，上游异常时保留占位输出，避免影响主流程。
- 建议生产环境启用稳定的 MCP/LLM 与 Redis 持久化；保持路径校验、路由拦截与占位回退策略。