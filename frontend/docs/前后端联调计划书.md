# 前后端联调计划书（travel_helper）

## 一、目标与范围
- 目标：完成 travel_helper 前端与后端（airAndroad backend）主要业务接口的端到端联调，保证核心场景可用并具备稳定的错误处理与导出能力。
- 范围：登录会话、目的地 POI/酒店分页筛选、行程路线生成、空铁组合推荐、LLM 聚合、导出 Markdown/PDF；不纳入订阅计费与安全深度治理（另行阶段）。

## 二、环境与启动
- 前端环境：Node ≥ 18，Vite + Vue3；在项目根执行 `npm i && npm run dev`，默认端口 `5173`。
- 后端环境：Node ≥ 20，Express + Redis + MySQL；建议先启动后端，再启动前端。
- 接入方式（二选一）：
  - 同源模式：前端静态服务与后端通过同源 `/api/...` 路由联通（推荐，避免 CORS）。
  - 开发代理：前端 `devServer.proxy` 将 `/api` 代理到后端地址（例如 `http://localhost:3000`），前端请求统一写 `/api/...`。
- 会话策略：后端采用 Redis 会话（`sid`），前端登录成功后由后端设置 `sid` Cookie 或返回 `sid`；后续请求携带 Cookie 或 `X-Session-ID`。

## 三、接口清单与优先级
- P0 级（优先联调）
  - `POST /api/auth/login`、`POST /api/auth/logout`：登录/登出，返回/清理 `sid`。
  - `GET /api/dest/poi`、`GET /api/dest/hotels`：分页与过滤（`city,page,pageSize,location,radius,district,tags,sort`）。
  - `GET /api/dest/routes`：融合高德路径规划与开放时段的 3–5 日行程草案（`city,days,interests,ratingMin,startDate`）。
  - `POST /api/recommendations`：空铁组合引擎（单段）返回 `timeFirst/priceFirst/balanced` 三套方案及评分拆解。
- P1 级（次优先）
  - `POST /api/llm/recommendations`：聚合多源数据（含 `engineCombos`）并进行 Top-K 前剪裁，输出建议与摘要。
  - `POST /api/export/md`、`POST /api/export/pdf`：导出文档（支持 `include_segments_detail` 偏好）。
- P2 级（可选）
  - `GET /metrics`：Prom 指标（开发联调阶段可在后端验证，不必前端展示）。

## 四、前端对接方案
- 配置：建议使用环境变量 `VITE_API_BASE`（如采用不同源），或统一以同源 `/api` 路径请求。
- 网络层：封装 Axios 实例（`baseURL` 指向 `/api` 或 `VITE_API_BASE`），开启 `withCredentials` 以携带 Cookie，会话头兼容 `X-Session-ID`。
- 错误处理：后端统一错误码映射为中文提示（示例）
  - `invalid_params`：参数不合法，请检查输入
  - `unauthorized`：未登录或会话已过期
  - `rate_limited`：访问过于频繁，请稍后再试
  - `not_found`：资源不存在或已删除
  - `internal_error`：服务端异常，请稍后再试
- 交互设计：
  - 登录后加载首页数据；未登录访问受保护接口时拦截并弹出登录框。
  - 列表分页采用骨架屏与加载更多；筛选条件（半径/行政区/标签/排序）与 URL 同步。
  - 导出触发后显示处理进度，完成提供下载链接并本地保存。

## 五、联调步骤（按序执行）
1. 登录联通
   - 动作：调用 `POST /api/auth/login`，校验返回的 `sid` 是否写入 Cookie；用 `GET /api/dest/poi` 验证会话有效。
   - 预期：已登录状态下接口返回 200；未登录时返回 401 并显示统一提示。
2. 目的地 POI/酒店分页
   - 动作：调用 `GET /api/dest/poi|hotels`，验证分页（`page,pageSize`）、过滤（`location,radius,district,tags`）、排序（`sort`）是否生效。
   - 预期：统一返回结构 `{ items, total, page, pageSize }`，翻页与筛选交互正常。
3. 行程路线生成
   - 动作：调用 `GET /api/dest/routes?city=上海&days=3&interests=博物馆,美食&ratingMin=4&startDate=2025-12-01`；页面按日展示 `dailyPlan` 与累计里程/耗时。
   - 预期：POI 时间窗与路径规划融合结果正确；拥挤避让与评分字段显示正常。
4. 空铁组合推荐
   - 动作：调用 `POST /api/recommendations`，展示 `timeFirst/priceFirst/balanced` 三类方案与评分拆解卡片。
   - 预期：评分维度（时间/价格/舒适度/换乘惩罚等）展示一致，排序与权重合规。
5. LLM 聚合
   - 动作：调用 `POST /api/llm/recommendations`，展示建议摘要与 Top-K 剪裁后的列表；显示 `engineCombos` 与 `stats`。
   - 预期：当主供应商不可用时自动降级（DeepSeek→SiliconFlow），响应稳定、内容可读。
6. 导出 Markdown/PDF
   - 动作：分别调用导出接口；PDF 验证中文字体、页眉页脚、两列布局；Markdown 验证目录与评分附录。
   - 预期：下载成功且版式稳定；包含偏好项 `include_segments_detail` 时内容完整。

## 六、测试用例与验收标准
- 登录
  - 用例：正确凭据登录 → 返回 200，Cookie 写入；错误凭据 → 返回 401，提示信息正确。
- POI/酒店分页
  - 用例：`page=1,pageSize=10` 返回 10 条；切至 `page=2` 返回下一页；设置 `radius=3000,district=黄浦区,tags=博物馆` 有效过滤。
- 路线生成
  - 用例：`days=3,interests=美食,博物馆` 输出 3 日计划；累计里程与耗时为数值，评分字段包含 `feasibilityScore/clusterScore/transferPenalty`。
- 推荐组合
  - 用例：三类方案均返回；评分拆解字段齐全；当输入约束（如时间窗）变化时，结果随之合理变化。
- LLM 聚合
  - 用例：正常返回含 `engineCombos`；模拟主供应商失败时降级仍有结果。
- 导出
  - 用例：生成 PDF 与 Markdown 文件，内容版式符合设计；大内容分页/目录正确。
- 验收标准：上述用例全部通过，前端交互无阻塞，错误提示一致，关键流程无 5xx 且无明显性能瓶颈。

## 七、监控与回滚
- 监控：后端 `/metrics` 查看缓存命中率、上游耗时与错误率；前端 DevTools 关注接口耗时与失败率。
- 回滚策略：如接口返回结构调整导致前端异常，先恢复到上一个可用版本的接口契约（或前端降级隐藏冲突字段），并在计划外补充契约约束说明。

## 八、风险与应对
- 风险：跨源导致 Cookie 不携带、接口限流命中、上游 MCP 抖动、评分权重不一致。
- 应对：
  - 使用同源或代理；Axios 开启 `withCredentials`。
  - 前端对频繁操作增加防抖/节流，后端限流提示友好。
  - 调用失败自动重试与降级链；在 UI 层提供重试与缓存提示。
  - 权重以后端配置为准，前端仅展示，不做本地计算。

## 九、数据安全与合规
- 输入校验与转义，禁止将用户输入直接渲染为 HTML。
- 敏感数据脱敏展示（手机号等）；会话仅通过 Cookie/请求头传递，禁止日志记录敏感信息。
- 所有接口调用使用参数化查询（由后端保障），前端不拼接 SQL。

## 十、排期（建议）
- Day 1：登录联通、POI/酒店分页
- Day 2：路线生成、组合推荐
- Day 3：LLM 聚合、导出与版式验收、联调复测与报告

> 备注：若后端实际端口或路径与本文不一致，请在前端 `.env.development` 或代理配置中调整 `VITE_API_BASE`/`/api` 对应地址，再按上述步骤联调。